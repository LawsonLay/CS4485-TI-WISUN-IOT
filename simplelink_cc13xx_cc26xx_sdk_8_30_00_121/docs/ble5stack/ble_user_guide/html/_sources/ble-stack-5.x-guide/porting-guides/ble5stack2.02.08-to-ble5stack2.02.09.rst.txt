.. |OLD_STACK_VER| replace:: BLE5-Stack 2.02.08
.. |NEW_STACK_VER| replace:: BLE5-Stack 2.02.09

|OLD_STACK_VER| (SDK 7.10) to |NEW_STACK_VER| (SDK 7.40)
========================================================

This section will describe a few methods to migrate a project from |OLD_STACK_VER| to
a |NEW_STACK_VER| project.

Porting via CCS ProjectSpec Modifications
-----------------------------------------

Porting by modifying the CCS ProjectSpec file (``.projectspec``) can be done when a ProjectSpec
file has been updated and maintained throughout the project's development. All
example projects included in the SDK each come with their own ProjectSpec file.
During development, the included ProjectSpec file should be updated to match any
changes or additions made to the project. This will make a project more easily
package-able and ease migration efforts when future SDK's are released
For example the ProjectSpec file of the simple_peripheral project is located in
``{SDK_INSTALL_DIR}\examples\rtos\{BOARD}\ble5stack\simple_peripheral\tirtos7\ticlang``

This portion of the migration guide will focus on how to port an existing 
project from |OLD_STACK_VER| to |NEW_STACK_VER| by modifying the ProjectSpec
file to import the project as a |NEW_STACK_VER| project. The following steps
will detail the changes needed when porting a Simple Peripheral project. 

.. warning:: This porting method might be more complex for customer specific
   projects. The following steps are the minimum set of changes
   required to port a project from |OLD_STACK_VER| to |NEW_STACK_VER|.

#. Open the ProjectSpec file in a text editor and modify the product definition
   line to reflect the new SDK revision and the corresponding sysconfig
   revision.
   ``products="com.ti.SIMPLELINK_CC13XX_CC26XX_SDK:x.xx.xx.xx;sysconfig:x.xx.x"``
   Refer to the Dependencies section in the SDK release notes for the correct
   SysConfig version. The SDK release notes may be found in 
   ``{SDK_INSTALL_DIR}\release_notes_simplelink_cc13xx_cc26xx_sdk_x_xx_xx_xx.html``

#. Update line ``cgtVersion="TICLANG_x.x.x"`` if it exists in the ProjectSpec
   file. Refer to the Dependencies section in the SDK release notes for the 
   recommended TI ARM Clang Compiler version.

#. In the ProjectSpec file, remove lines ``@${PROJECT_LOC}/${ConfigName}/syscfg/ti_ble_app_config.opt``
   and ``@${PROJECT_LOC}/${ConfigName}/syscfg/ti_build_config.opt``.

#. In the ProjectSpec file, ensure the ``linkerBuildOptions=`` section
   has the following entries:

   .. code-block:: bash
      
      :linenos:
      linkerBuildOptions="
         -Wl,--diag_wrap=off
         -Wl,--display_error_number
         -Wl,-x
         -Wl,--diag_suppress=16002-D
         -Wl,--diag_suppress=10247-D
         -Wl,--diag_suppress=10325-D
         -Wl,--diag_suppress=10229-D
         -Wl,--diag_suppress=16032-D
         -Wl,-c
         -L${COM_TI_SIMPLELINK_CC13XX_CC26XX_SDK_INSTALL_DIR}/source
         -L${COM_TI_SIMPLELINK_CC13XX_CC26XX_SDK_INSTALL_DIR}/kernel/tirtos7/packages
         -Wl,--define=FLASH_ROM_BUILD=2
         -L${PROJECT_BUILD_DIR}/syscfg
         -lti_utils_build_linker.cmd.genlibs
         -Wl,--rom_model
         -Wl,--warn_sections
         -L${CG_TOOL_ROOT}/lib
         -llibc.a
      "

#. In the ProjectSpec, modify the ``postBuildStep=`` to be
   ``${CG_TOOL_ROOT}/bin/tiarmobjcopy -O ihex ${BuildArtifactFileName} ${BuildArtifactFileBaseName}.hex``.

#. In the linking portion of the ProjectSpec, replace ``<file path="${COM_TI_SIMPLELINK_CC13XX_CC26XX_SDK_INSTALL_DIR}/source/ti/ble5stack/common/cc26xx/util.c" openOnCreation="false" excludeFromBuild="false" action="link" targetDirectory="Application">``
   with ``<file path="${COM_TI_SIMPLELINK_CC13XX_CC26XX_SDK_INSTALL_DIR}/source/ti/ble5stack/common/cc26xx/util.c" openOnCreation="false" excludeFromBuild="false" action="link" targetDirectory="common/Util">``.
   Also replace ``<file path="${COM_TI_SIMPLELINK_CC13XX_CC26XX_SDK_INSTALL_DIR}/source/ti/ble5stack/common/cc26xx/util.h" openOnCreation="false" excludeFromBuild="false" action="link" targetDirectory="Application">``
   with ``<file path="${COM_TI_SIMPLELINK_CC13XX_CC26XX_SDK_INSTALL_DIR}/source/ti/ble5stack/common/cc26xx/util.h" openOnCreation="false" excludeFromBuild="false" action="link" targetDirectory="common/Util">``.

#. In the file ``osal_icall_ble.c`` under ``...\Startup\``, remove the
   replace the ``GATTServApp_Init( taskID++, cfg_GATTServApp_att_delayed_req, cfg_gapBond_gatt_no_service_changed );``
   line with ``GATTServApp_Init( taskID++, cfg_GATTServApp_att_delayed_req, cfg_gapBond_gatt_no_service_changed, cfg_gatt_max_num_prepare_writes );``.
   Within the ``osalInitTasks()``, add the following declaration and initialization
   ``uint8_t cfg_gatt_max_num_prepare_writes = 0;``. After the 
   variable declaration and initialization section of the
   ``osalInitTasks()`` function add the following:

   .. code-block:: c

      :linenos:
      #if defined ( GATT_MAX_PREPARE_WRITES )
         cfg_gatt_max_num_prepare_writes = GATT_MAX_PREPARE_WRITES;
      #endif


#. In the file simple_peripheral.syscfg under ``...\tirtos7\``, remove the
   line ``ble.advSet1.scanRes1.GAP_ADTYPE_SLAVE_CONN_INTERVAL_RANGE = true;`` 
   and replace it with lines ``const connIntervalRange = system.getScript("/ti/ble5stack/ble_common.js").getPeripheralConnIntervalRange();``
   and ``ble.advSet1.scanRes1[connIntervalRange] = true;``

   Alternatively replace the simple_peripheral.syscfg with the file, provided
   with the new SDK.

#. Replace all instances of ``DEFAULT_DESIRED_SLAVE_LATENCY`` 
   with ``DEFAULT_DESIRED_PERIPHERAL_LATENCY`` in application files.

#. Afterwards, the project may be re-imported using the new ProjectSpec file.
   The newly imported project is now configured to use |NEW_STACK_VER| instead
   of |OLD_STACK_VER|.

To learn more information about ProjectSpec files, please 
reference `ProjectSpec Documentation <https://software-dl.ti.com/ccs/esd/documents/ccs_projectspecs.html>`_.

Porting by modifying the project properties in CCS
--------------------------------------------------

An equivalent way of porting an existing project to a newer SDK is to modify
the project properties in CCS.

.. warning:: This porting method might be more complex for customer specific
   projects. The following steps are the minimum set of changes
   required to port a project from |OLD_STACK_VER| to |NEW_STACK_VER|.

In this example the simple_peripheral project of the |OLD_STACK_VER| will be
ported to |NEW_STACK_VER| with the following steps:

#. In the |OLD_STACK_VER| simple_peripheral CCS project, right-click on the 
   project name and select ``Properties`` or use the CCS menu ``Project`` -
   ``Properties``.

#. Under ``Resource`` - ``General`` click the ``Products`` tab and select the
   ``SimpleLink CC13xx CC26xx SDK`` entry and press the ``Edit`` button.

#. Select the new SDK from the drop-down field on the right side and press OK.

#. In the same tab select the SysConfig entry and update similarly if needed.
   Refer to the Dependencies section in the SDK release notes for the correct
   SysConfig version. The SDK release notes may be found in 
   ``{SDK_INSTALL_DIR}\release_notes_simplelink_cc13xx_cc26xx_sdk_x_xx_xx_xx.html``

#. Under ``Resource`` - ``General`` click the ``Project`` tab and select the
   desired compiler version. Refer to the Dependencies section in the SDK
   release notes for the correct compiler version. The SDK release notes may be
   found in 
   ``{SDK_INSTALL_DIR}\release_notes_simplelink_cc13xx_cc26xx_sdk_x_xx_xx_xx.html``

#. Under ``Build`` - ``Arm Compiler`` - ``Advanced Options`` - ``Command Files``
   delete entries ``${PROJECT_LOC}/${ConfigName}/syscfg/ti_ble_app_config.opt``
   and ``${PROJECT_LOC}/${ConfigName}/syscfg/ti_build_config.opt``.

#. In the file ``osal_icall_ble.c`` under ``...\Startup\``, remove the
   replace the ``GATTServApp_Init( taskID++, cfg_GATTServApp_att_delayed_req, cfg_gapBond_gatt_no_service_changed );``
   line with ``GATTServApp_Init( taskID++, cfg_GATTServApp_att_delayed_req, cfg_gapBond_gatt_no_service_changed, cfg_gatt_max_num_prepare_writes );``.
   Within the ``osalInitTasks()``, add the following declaration and initialization
   ``uint8_t cfg_gatt_max_num_prepare_writes = 0;``. After the 
   variable declaration and initialization section of the
   ``osalInitTasks()`` function add the following:

   .. code-block:: c

      :linenos:
      #if defined ( GATT_MAX_PREPARE_WRITES )
         cfg_gatt_max_num_prepare_writes = GATT_MAX_PREPARE_WRITES;
      #endif

#. In the file simple_peripheral.syscfg under ``...\tirtos7\``, remove the
   line ``ble.advSet1.scanRes1.GAP_ADTYPE_SLAVE_CONN_INTERVAL_RANGE = true;`` 
   and replace it with lines ``const connIntervalRange = system.getScript("/ti/ble5stack/ble_common.js").getPeripheralConnIntervalRange();``
   and ``ble.advSet1.scanRes1[connIntervalRange] = true;``

#. Replace all instances of ``DEFAULT_DESIRED_SLAVE_LATENCY`` 
   with ``DEFAULT_DESIRED_PERIPHERAL_LATENCY`` in application files.

Now it should be possible to build and run the ported project.

Legacy Porting
--------------

The following three sections are covering a legacy migration method for
different examples. The approach of this method is to open a new project from
the new SDK and transfer your changes and application code over to the new
example.

Legacy Porting Simple Peripheral
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

For this migration guide, Simple Peripheral from |OLD_STACK_VER| will be 
ported over to |NEW_STACK_VER|. Start with a |NEW_STACK_VER| project that
contains the same base functionality as the porting target project and merge in
any custom functionality.

#. Choose a |NEW_STACK_VER| example project that contains your target
   project's base functionality.

#. Transfer all modified application files from |OLD_STACK_VER| into the
   |NEW_STACK_VER| example project.

   In this example, the following files from |OLD_STACK_VER| were moved into
   Simple Peripheral |NEW_STACK_VER| example:

      - ``simple_peripheral.c``
      - ``simple_peripheral.h``

#. Move any profiles and services that the application is using to the 
   |NEW_STACK_VER| project.

#. Transfer the SysConfig settings either visually through the GUI or open both 
   the old and the new project ``.syscfg`` files and copy-paste the desired 
   settings.

#. If necessary, update the project to use the newer TI-RTOS drivers that are
   supplied with the |SDK|. Additional details are provided 
   in :ref:`noteworthy-ble-migration-sdk-7-40`.

#. Refer to the Core SDK release notes for additional information and the 
   TI-RTOS examples included with |SDK|. The Core SDK release notes may be
   found in ``{SDK_INSTALL_DIR}\docs\simplelink_mcu_sdk\release_notes_coresdk_cc13xx_cc26xx_x_xx_xx_xx.html``

   For additional information on how |NEW_STACK_VER| uses TI-RTOS see
   :ref:`sec-tirtos-overview`.

   For any utilized TI Drivers, review |TI-RTOS_UG_BLE_MG_LOC| and |TI_DRIVERS_API_BLE_MG_LOC|.

Legacy Porting Simple Central
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

This section of the migration guide will focus on porting Simple Central 
from |OLD_STACK_VER| to the |NEW_STACK_VER|. Start with a |NEW_STACK_VER|
project that contains the same base functionality as the porting target project
and merge in any custom functionality.

#. Choose a |NEW_STACK_VER| example project that contains your target
   project's base functionality.

#. Transfer all modified application files from |OLD_STACK_VER| into the
   |NEW_STACK_VER| example project.

   In this example, the following files from |OLD_STACK_VER| were moved into
   Simple Central |NEW_STACK_VER| example:

      - ``simple_central.c``
      - ``simple_central.h``

#. Modify ``main.c`` in the |NEW_STACK_VER| example if additional tasks were
   added in the |OLD_STACK_VER| project.

#. Move any profiles and services that the application is using to the
   |NEW_STACK_VER|.

#. Transfer the Sysconfig settings either visually through the GUI or open both 
   the old and the new project ``.syscfg`` files and copy-paste the desired settings.

#. If necessary, update the project to use the newer TI-RTOS drivers that are
   supplied with the |SDK|. Additional details are provided 
   in :ref:`noteworthy-ble-migration-sdk-7-40`.

#. Refer to the Core SDK release notes for additional information and the TI-RTOS
   examples included with |SDK|.  The Core SDK release notes may be
   found in ``{SDK_INSTALL_DIR}\docs\simplelink_mcu_sdk\release_notes_coresdk_cc13xx_cc26xx_x_xx_xx_xx.html``

   For additional information on how |NEW_STACK_VER| uses TI-RTOS see
   :ref:`sec-tirtos-overview`.

   For any utilized TI Drivers, review |TI-RTOS_UG_BLE_MG_LOC| and |TI_DRIVERS_API_BLE_MG_LOC|.

Legacy Porting Basic BLE
^^^^^^^^^^^^^^^^^^^^^^^^

In this section of this migration guide, the Basic BLE example from
|OLD_STACK_VER| will be ported over to |NEW_STACK_VER|. Start with the Basic
BLE project of the |NEW_STACK_VER| and merge in any custom functionality.

#. Import a |NEW_STACK_VER| Basic BLE project.

#. Change the default BLE Basic project configuration options in the BLE Module
   present in SysConfig to match the configuration used in the |OLD_STACK_VER|
   project.

#. Transfer all modified application files from |OLD_STACK_VER| into the
   |NEW_STACK_VER| example project.

   In this example, the following files from |OLD_STACK_VER| were moved into
   the Basic BLE example of the |NEW_STACK_VER|:

      - ``app_peripheral.c``
      - ``app_central.c``

#. Move any profiles and services that the application is using to the 
   |NEW_STACK_VER| project.

#. Transfer the SysConfig settings either visually through the GUI or open both 
   the old and the new project ``.syscfg`` files and copy-paste the desired 
   settings.

#. If necessary, update the project to use the newer TI-RTOS drivers that are
   supplied with the |SDK|. Additional details are provided 
   in :ref:`noteworthy-ble-migration-sdk-7-40`.

#. Refer to the Core SDK release notes for additional information and the 
   TI-RTOS examples included with |SDK|. The Core SDK release notes may be
   found in ``{SDK_INSTALL_DIR}\docs\simplelink_mcu_sdk\release_notes_coresdk_cc13xx_cc26xx_x_xx_xx_xx.html``

   For additional information on how |NEW_STACK_VER| uses TI-RTOS see
   :ref:`sec-tirtos-overview`.

   For any utilized TI Drivers, review |TI-RTOS_UG_BLE_MG_LOC| and |TI_DRIVERS_API_BLE_MG_LOC|.

.. _noteworthy-ble-migration-sdk-7-40:

A Few Noteworthy Changes from |OLD_STACK_VER| to |NEW_STACK_VER|
----------------------------------------------------------------

You can follow the guide above without addressing these updates, they are listed
for your information only. All fine grained details might not be mentioned, 
please refer to the specific example you need to port and do a compare between 
the old and new project files. Please refer to the |STACK| Release Notes for 
all the details.

.. note::
   The ``GPIO_setMux()`` function has been deprecated and replaced
   by the ``GPIO_setConfigAndMux()``. For more information,
   please reference the :ref:`sec-cc13xx-cc26xx-gpio++-porting-guide`.

.. note::   
   The examples available in SDK 6.20 and newer

   - Rely either on TI-RTOS7 or FreeRTOS as RTOS
   - Leverage GPIO++ and UART2 drivers for GPIO and UART applications
   - Use TI-CLANG or IAR as compiler
  
   This guide assumes the previously mentioned components are used. If this is not the case for your projects,
   please refer to :ref:`tirtos_to_tirtos7-porting-guide`, :ref:`sec-cc13xx-cc26xx-gpio++-porting-guide`, :ref:`uart_to_uart2-porting-guide`
   and `TI ARM Clang Migration Guide <https://software-dl.ti.com/codegen/docs/tiarmclang/rel1_0_0_sts/tiarmclang_ug/tiarmclang-portfolio/migration_guide/index.html>`_.

.. note::   
   Several Function names, structure field names, defines, and SysConfig field
   names have been updated in order to follow inclusive technical terminology.
   Refer to the Inclusive Terminology section in the Core SDK release notes for
   more details and for a list of affected APIs. The Core SDK release notes may
   be found in ``{SDK_INSTALL_DIR}\docs\simplelink_mcu_sdk\release_notes_coresdk_cc13xx_cc26xx_x_xx_xx_xx.html``